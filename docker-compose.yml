services:

  # Proxy Server - The ONLY service exposing ports
  proxy-server:
    image: nginx:alpine
    container_name: proxy-server
    ports:
      - "80:80"
      - "443:443"
    environment:
      - TZ=Asia/Bangkok
    volumes:
      - ./proxy-server/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./certs/proxy-server.crt:/etc/nginx/certs/proxy-server.crt:ro
      - ./certs/proxy-server.key:/etc/nginx/certs/proxy-server.key:ro
      - nginx_logs:/var/log/nginx
    depends_on:
      - user-db-api 
      - icu-db-api   
      - or-db-api   
    networks:
      - app-network
    restart: unless-stopped

  # Node.js Register Service
  register-frontend:
    build:
      context: ./register-frontend
      dockerfile: Dockerfile
    container_name: register-frontend
    # ports removed for security
    user: "node"
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.50'
          memory: 512M
        reservations:
          memory: 128M
    volumes:
      - ./certs/combine_cert.pem:/usr/src/app/cert/combine_cert.pem:ro
      - ./certs/register-frontend.crt:/usr/src/app/cert/register-frontend.crt:ro
      - ./certs/register-frontend.key:/usr/src/app/cert/register-frontend.key:ro      
    environment:
      - NODE_ENV=production
      - TZ=Asia/Bangkok
      - NODE_EXTRA_CA_CERTS=/usr/src/app/cert/combine_cert.pem      
    depends_on:
      proxy-server:
        condition: service_started
    networks:
      - app-network

  # Node.js ICU dashboard frontend
  icu-frontend:
    build:
      context: ./icu-frontend
      dockerfile: Dockerfile
    container_name: icu-frontend
    # ports removed for security
    user: "node"
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.50'
          memory: 512M
        reservations:
          memory: 128M
    volumes:
      - ./certs/combine_cert.pem:/usr/src/app/cert/combine_cert.pem:ro
      - ./certs/icu-frontend.crt:/usr/src/app/cert/icu-frontend.crt:ro
      - ./certs/icu-frontend.key:/usr/src/app/cert/icu-frontend.key:ro      
    environment:
      - NODE_ENV=production
      - TZ=Asia/Bangkok
      - NODE_EXTRA_CA_CERTS=/usr/src/app/cert/combine_cert.pem      
    depends_on:
      proxy-server:
        condition: service_started
    networks:
      - app-network      

  # Node.js backend Service
  register-backend:
    build:
      context: ./register-backend
      dockerfile: Dockerfile
    container_name: register-backend
    # ports removed for security
    user: "node"
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.50'
          memory: 512M
        reservations:
          memory: 128M
    volumes:
      - ./certs/combine_cert.pem:/usr/src/app/cert/combine_cert.pem:ro
      - ./certs/register-backend.crt:/usr/src/app/cert/register-backend.crt:ro
      - ./certs/register-backend.key:/usr/src/app/cert/register-backend.key:ro
    environment:
      - NODE_ENV=production
      - TZ=Asia/Bangkok
      - NODE_EXTRA_CA_CERTS=/usr/src/app/cert/combine_cert.pem
    depends_on:
      proxy-server:
        condition: service_started
    networks:
      - app-network

  # Node.js backend Service
  icu-backend:
    build:
      context: ./icu-backend
      dockerfile: Dockerfile
    container_name: icu-backend
    # ports removed for security
    user: "node"
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.50'
          memory: 512M
        reservations:
          memory: 128M
    volumes:
      - ./certs/combine_cert.pem:/usr/src/app/cert/combine_cert.pem:ro
      - ./certs/icu-backend.crt:/usr/src/app/cert/icu-backend.crt:ro
      - ./certs/icu-backend.key:/usr/src/app/cert/icu-backend.key:ro
    environment:
      - NODE_ENV=production
      - TZ=Asia/Bangkok
      - NODE_EXTRA_CA_CERTS=/usr/src/app/cert/combine_cert.pem
    depends_on:
      proxy-server:
        condition: service_started
    networks:
      - app-network  

  # Node.js backend Service
  or-monitor-backend:
    build:
      context: ./or-monitor-backend
      dockerfile: Dockerfile
    container_name: or-monitor-backend
    # ports removed for security
    user: "node"
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.50'
          memory: 512M
        reservations:
          memory: 128M
    volumes:
      - ./certs/combine_cert.pem:/usr/src/app/cert/combine_cert.pem:ro
      - ./certs/or-monitor-backend.crt:/usr/src/app/cert/or-monitor-backend.crt:ro
      - ./certs/or-monitor-backend.key:/usr/src/app/cert/or-monitor-backend.key:ro
    environment:
      - NODE_ENV=production
      - TZ=Asia/Bangkok
      - NODE_EXTRA_CA_CERTS=/usr/src/app/cert/combine_cert.pem
    depends_on:
      proxy-server:
        condition: service_started
    networks:
      - app-network    


  # Node.js backend Service
  authen-server:
    build:
      context: ./authen-server
      dockerfile: Dockerfile
    container_name: authen-server
    # ports removed for security
    user: "node"
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.50'
          memory: 512M
        reservations:
          memory: 128M
    volumes:
      - ./certs/combine_cert.pem:/usr/src/app/cert/combine_cert.pem:ro
      - ./certs/authen-server.crt:/usr/src/app/cert/authen-server.crt:ro
      - ./certs/authen-server.key:/usr/src/app/cert/authen-server.key:ro
    environment:
      - NODE_ENV=production
      - TZ=Asia/Bangkok
      - NODE_EXTRA_CA_CERTS=/usr/src/app/cert/combine_cert.pem
    depends_on:
      proxy-server:
        condition: service_started
    networks:
      - app-network       


  # HOSxP API Server Service
  hosxp-api:
    build:
      context: ./hosxp-api
      dockerfile: Dockerfile
    container_name: hosxp-api
    # ports removed for security
    user: "node"
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.50'
          memory: 512M
        reservations:
          memory: 128M
    volumes:
      - ./certs/combine_cert.pem:/usr/src/app/cert/combine_cert.pem:ro
      - ./certs/hosxp-api.crt:/usr/src/app/cert/hosxp-api.crt:ro
      - ./certs/hosxp-api.key:/usr/src/app/cert/hosxp-api.key:ro
      - ./keys/public-key/hosxp-api-public-key.pem:/usr/src/app/public-key/hosxp-api-public-key.pem:ro
    environment:
      - NODE_ENV=production
      - TZ=Asia/Bangkok
      - NODE_EXTRA_CA_CERTS=/usr/src/app/cert/combine_cert.pem      
    depends_on:
      proxy-server:
        condition: service_started
    networks:
      - app-network

  # Line Webhook Server Service
  line-webhook-server:
    build:
      context: ./line-webhook-server
      dockerfile: Dockerfile
    container_name: line-webhook-server
    # ports removed for security
    user: "node"
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.50'
          memory: 512M
        reservations:
          memory: 128M
    volumes:
      - ./certs/combine_cert.pem:/usr/src/app/cert/combine_cert.pem:ro
      - ./certs/line-webhook-server.crt:/usr/src/app/cert/line-webhook-server.crt:ro
      - ./certs/line-webhook-server.key:/usr/src/app/cert/line-webhook-server.key:ro
    environment:
      - NODE_ENV=production
      - TZ=Asia/Bangkok
      - NODE_EXTRA_CA_CERTS=/usr/src/app/cert/combine_cert.pem      
    depends_on:
      proxy-server:
        condition: service_started
    networks:
      - app-network

  # Logic Server Service
  logic-server:
    build:
      context: ./logic-server
      dockerfile: Dockerfile
    container_name: logic-server
    # ports removed for security
    user: "node"
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.50'
          memory: 512M
        reservations:
          memory: 128M
    volumes:
      - ./certs/combine_cert.pem:/usr/src/app/cert/combine_cert.pem:ro
      - ./certs/logic-server.crt:/usr/src/app/cert/logic-server.crt:ro
      - ./certs/logic-server.key:/usr/src/app/cert/logic-server.key:ro
      - ./keys/public-key/logic-server-api-public-key.pem:/usr/src/app/public-key/logic-server-api-public-key.pem:ro
    environment:
      - NODE_ENV=production
      - TZ=Asia/Bangkok
      - NODE_EXTRA_CA_CERTS=/usr/src/app/cert/combine_cert.pem      
    depends_on:
      proxy-server:
        condition: service_started
    networks:
      - app-network

  # User DB API Server Service
  user-db-api:
    build:
      context: ./user-db-api
      dockerfile: Dockerfile
    container_name: user-db-api
    # ports removed for security
    user: "node"
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.50'
          memory: 512M
        reservations:
          memory: 128M
    volumes:
      - ./certs/combine_cert.pem:/usr/src/app/cert/combine_cert.pem:ro
      - ./certs/user-db-api.crt:/usr/src/app/cert/user-db-api.crt:ro
      - ./certs/user-db-api.key:/usr/src/app/cert/user-db-api.key:ro
      - ./keys/public-key/user-db-api-public-key.pem:/usr/src/app/public-key/user-db-api-public-key.pem:ro
    depends_on:
      user-db:
        condition: service_healthy      
    environment:
      - NODE_ENV=production
      - TZ=Asia/Bangkok
      - NODE_EXTRA_CA_CERTS=/usr/src/app/cert/combine_cert.pem
    networks:
      - app-network

  # ICU DB API Server Service
  icu-db-api:
    build:
      context: ./icu-db-api
      dockerfile: Dockerfile
    container_name: icu-db-api
    # ports removed for security
    user: "node"
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.50'
          memory: 512M
        reservations:
          memory: 128M
    volumes:
      - ./certs/combine_cert.pem:/usr/src/app/cert/combine_cert.pem:ro
      - ./certs/icu-db-api.crt:/usr/src/app/cert/icu-db-api.crt:ro
      - ./certs/icu-db-api.key:/usr/src/app/cert/icu-db-api.key:ro
      - ./keys/public-key/icu-db-api-public-key.pem:/usr/src/app/public-key/icu-db-api-public-key.pem:ro
    depends_on:
      icu-db:
        condition: service_healthy      
    environment:
      - NODE_ENV=production
      - TZ=Asia/Bangkok
      - NODE_EXTRA_CA_CERTS=/usr/src/app/cert/combine_cert.pem
    networks:
      - app-network

  # OR DB API Server Service
  or-db-api:
    build:
      context: ./or-db-api
      dockerfile: Dockerfile
    container_name: or-db-api
    # ports removed for security
    user: "node"
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.50'
          memory: 512M
        reservations:
          memory: 128M
    volumes:
      - ./certs/combine_cert.pem:/usr/src/app/cert/combine_cert.pem:ro
      - ./certs/or-db-api.crt:/usr/src/app/cert/or-db-api.crt:ro
      - ./certs/or-db-api.key:/usr/src/app/cert/or-db-api.key:ro
      - ./keys/public-key/or-db-api-public-key.pem:/usr/src/app/public-key/or-db-api-public-key.pem:ro
    depends_on:
      or-db:
        condition: service_healthy      
    environment:
      - NODE_ENV=production
      - TZ=Asia/Bangkok
      - NODE_EXTRA_CA_CERTS=/usr/src/app/cert/combine_cert.pem
    networks:
      - app-network

  # File Server Service
  file-server:
    build:
      context: ./file-server
      dockerfile: Dockerfile
    container_name: file-server
    # ports removed for security
    user: "node"
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.50'
          memory: 512M
        reservations:
          memory: 128M
    volumes:
      - ./certs/combine_cert.pem:/usr/src/app/cert/combine_cert.pem:ro
      - ./certs/file-server.crt:/usr/src/app/cert/file-server.crt:ro
      - ./certs/file-server.key:/usr/src/app/cert/file-server.key:ro
    environment:
      - NODE_ENV=production
      - TZ=Asia/Bangkok
      - NODE_EXTRA_CA_CERTS=/usr/src/app/cert/combine_cert.pem      
    depends_on:
      proxy-server:
        condition: service_started
    networks:
      - app-network

  # User DB MySQL Server
  user-db:
    image: mysql:9
    container_name: user-db
    restart: always
    healthcheck:
      test: ['CMD-SHELL', 'mysqladmin ping -h 127.0.0.1 --password="$$(cat /run/secrets/user-mysql-root-password)" --silent']
      interval: 3s
      retries: 5
      start_period: 30s
    secrets:
      - user-mysql-root-password
      - user-mysql-user-password
    environment:
      - MYSQL_ROOT_PASSWORD_FILE=/run/secrets/user-mysql-root-password
      - MYSQL_DATABASE=user_db
      - MYSQL_USER=nakorn
      - MYSQL_PASSWORD_FILE=/run/secrets/user-mysql-user-password
      - TZ=Asia/Bangkok
    # Ports removed for security (access only via app-network)
    volumes:
      - ./user-db/my.cnf:/etc/mysql/my.cnf
      - ./user-db/init.sql:/docker-entrypoint-initdb.d/init.sql
      - user-data:/var/lib/mysql
    networks:
      - app-network

  # ICU DB MySQL Server
  icu-db:
    image: mysql:9
    container_name: icu-db
    restart: always
    healthcheck:
      test: ['CMD-SHELL', 'mysqladmin ping -h 127.0.0.1 --password="$$(cat /run/secrets/icu-mysql-root-password)" --silent']
      interval: 3s
      retries: 5
      start_period: 30s
    secrets:
      - icu-mysql-root-password
      - icu-mysql-user-password
    environment:
      - MYSQL_ROOT_PASSWORD_FILE=/run/secrets/icu-mysql-root-password
      - MYSQL_DATABASE=icu_db
      - MYSQL_USER=nakorn
      - MYSQL_PASSWORD_FILE=/run/secrets/icu-mysql-user-password
      - TZ=Asia/Bangkok
    # Ports removed for security (access only via app-network)
    volumes:
      - ./icu-db/my.cnf:/etc/mysql/my.cnf
      - ./icu-db/init.sql:/docker-entrypoint-initdb.d/init.sql
      - icu-data:/var/lib/mysql
    networks:
      - app-network

  # OR DB MySQL Server
  or-db:
    image: mysql:9
    container_name: or-db
    restart: always
    healthcheck:
      test: ['CMD-SHELL', 'mysqladmin ping -h 127.0.0.1 --password="$$(cat /run/secrets/or-mysql-root-password)" --silent']
      interval: 3s
      retries: 5
      start_period: 30s
    secrets:
      - or-mysql-root-password
      - or-mysql-user-password
    environment:
      - MYSQL_ROOT_PASSWORD_FILE=/run/secrets/or-mysql-root-password
      - MYSQL_DATABASE=or_db
      - MYSQL_USER=nakorn
      - MYSQL_PASSWORD_FILE=/run/secrets/or-mysql-user-password
      - TZ=Asia/Bangkok
    # Ports removed for security (access only via app-network)
    volumes:
      - ./or-db/my.cnf:/etc/mysql/my.cnf
      - ./or-db/init.sql:/docker-entrypoint-initdb.d/init.sql
      - or-data:/var/lib/mysql
    networks:
      - app-network

# Network
networks:
  app-network:
    name: app-network
    driver: bridge

# Volume
volumes:
  user-data:
    name: user-data
  icu-data:
    name: icu-data
  or-data:
    name: or-data
  nginx_logs:
    name: nginx_logs

# Secret
secrets:
  user-mysql-root-password:
    file: ./user-db/MySQL_root.password
  user-mysql-user-password:
    file: ./user-db/MySQL_user.password    
  icu-mysql-root-password:
    file: ./icu-db/MySQL_root.password
  icu-mysql-user-password:
    file: ./icu-db/MySQL_user.password
  or-mysql-root-password:
    file: ./or-db/MySQL_root.password
  or-mysql-user-password:
    file: ./or-db/MySQL_user.password  