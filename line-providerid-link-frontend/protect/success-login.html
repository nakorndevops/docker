<!DOCTYPE html>
<html lang="en">

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registration</title>

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #ffffff;
        }

        .container {
            display: none;
            background-color: #ffffff;
            padding: 2rem;
            border-radius: 8px;
            /* Removed border and box-shadow */
            text-align: center;
            max-width: 90%;
            box-sizing: border-box;
        }

        .success {
            color: #28a745;
            margin-bottom: 1.5rem;
        }

        .info-grid {
            display: grid;
            grid-template-columns: max-content 1fr;
            gap: 0.5rem 1rem;
            text-align: left;
            margin: 0 auto;
            width: fit-content;
            margin-bottom: 2rem;
            /* Added space for the button */
        }

        .label {
            font-weight: bold;
            text-align: left;
            color: #333;
        }

        .value {
            color: #555;
            text-align: right;
        }

        .close-btn {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .close-btn:hover {
            background-color: #218838;
        }

        .container-error {
            display: none;
            background-color: #ffffff;
            padding: 2rem;
            border-radius: 8px;
            text-align: center;
            max-width: 400px;
            width: 90%;
            box-sizing: border-box;
        }

        .fail {
            color: #dc3545;
            /* Red */
            margin-top: 0;
            margin-bottom: 0.5rem;
        }

        .error-message {
            color: #6c757d;
            /* Gray */
            margin-bottom: 1.5rem;
            font-size: 1.1em;
        }

        .close-btn-error {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .close-btn-error:hover {
            background-color: #c82333;
        }
    </style>

</head>

<script charset="utf-8" src="https://static.line-scdn.net/liff/edge/versions/2.22.3/sdk.js"></script>

<body>

    <div id="successRegistration" class="container">
        <h1 class="success">Registration success</h1>
        <div class="info-grid">
            <div class="label">ชื่อ-สกุล</div>
            <div id="name_th" class="value"></div>
            <div class="label">วิชาชีพ</div>
            <div id="position" class="value"></div>
            <div class="label">เลขใบประกอบวิชาชีพ</div>
            <div id="license_id" class="value"></div>
            <div class="label">สังกัด</div>
            <div id="hname_th" class="value"></div>
        </div>

        <button class="close-btn" onclick="closeLiffApp()">Close Window</button>
    </div>

    <div id="failedRegistration" class="container-error">
        <h1 class="fail">Registration Failed</h1>
        <p id="errorMessage" class="error-message"></p>
        <button class="close-btn-error" onclick="closeLiffApp()">Close</button>
    </div>

</body>

<script>
    const showLoginResult = document.getElementById("showLoginResult");

    async function initializeLiff(liffIds) {
        try {
            await liff.init({ liffId: liffIds });
            // Start to use LIFF's API
        } catch (err) {
            // Error during initialization
            console.error(err.code, err.message);
        }
    }

    async function verifyAccessToken(accessToken) {
        // 1. Validate the input parameter
        if (!accessToken) {
            throw new Error('Access token is required for verification.');
        }

        // 2. Use the URL API for safe query parameter handling
        const url = new URL('https://api.line.me/oauth2/v2.1/verify');
        url.searchParams.append('access_token', accessToken);

        try {
            const response = await fetch(url);

            // 3. Check if the HTTP response status is OK (e.g., 200)
            if (!response.ok) {
                // Provide a more detailed error message including the status code
                throw new Error(`API request failed with status ${response.status}: ${response.statusText}`);
            }

            // 4. Parse the JSON body and return it
            return await response.json();

        } catch (error) {
            // 5. Catch network errors and re-throw for the caller to handle
            console.error('Error verifying access token:', error.message);
            // Re-throwing the error allows the calling function to handle the failure.
            throw error;
        }
    }

    async function getUserProfile(accessToken) {
        const url = 'https://api.line.me/v2/profile';

        try {
            const response = await fetch(url, {
                method: 'GET', // Corresponds to -X GET in cURL
                headers: {
                    // Corresponds to -H 'Authorization: Bearer ...' in cURL
                    'Authorization': `Bearer ${accessToken}`,
                },
            });

            // Check if the request was successful
            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }

            // Parse the JSON response from the API
            const profileData = await response.json();
            return profileData;

        } catch (error) {
            // Handle any errors that occurred during the fetch
            console.error('Could not fetch profile:', error);
        }
    }

    function closeLiffApp() {
        liff.closeWindow();
    }

    window.onload = async function () {

        await initializeLiff("2007923339-6OOe9xPE");

        let lineLoginUrl = "https://dh.tranghos.moph.go.th";

        if (!liff.isLoggedIn()) {
            window.location.replace(lineLoginUrl);
        } else {

            const successRegistration = document.getElementById("successRegistration");
            const name_th = document.getElementById("name_th");
            const position = document.getElementById("position");
            const license_id = document.getElementById("license_id");
            const hname_th = document.getElementById("hname_th");

            const failedRegistration = document.getElementById("failedRegistration");
            const errorMessage = document.getElementById("errorMessage");

            // Get Access Token
            const accessToken = await liff.getAccessToken();

            // Get User Profile
            const lineUserProfile = await getUserProfile(accessToken);
            const LineUserId = lineUserProfile.userId;

            // Get providerID Code
            const queryString = window.location.search;
            const urlParams = new URLSearchParams(queryString);
            const providerIdCode = urlParams.get('code');

            // Get currentUrl
            const currentUrl = window.location.href.split('?')[0];

            const endpointUrl = 'https://dh.tranghos.moph.go.th/line-providerid-link-backend/linkAccount';

            // Prepare the data to be sent in the request body
            const requestData = {
                LineUserId: LineUserId,
                providerIdCode: providerIdCode,
                redirect_uri: currentUrl
            };

            try {
                // Make the POST request using the fetch API
                const response = await fetch(endpointUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                    },
                    // Convert the JavaScript object to a JSON string
                    body: JSON.stringify(requestData),
                });

                const userProfile = await response.json();

                if (response.status == 200) {
                    successRegistration.style.display = "block";
                    name_th.innerHTML = userProfile.data.name_th;
                    position.innerHTML = userProfile.data.organization[0].position;
                    license_id.innerHTML = userProfile.data.organization[0].license_id;
                    hname_th.innerHTML = userProfile.data.organization[0].hname_th;
                } else {
                    failedRegistration.style.display = "block";
                    errorMessage.innerHTML = userProfile.error;
                }

            } catch (error) {
                failedRegistration.style.display = "block";
                errorMessage.innerHTML = 'There was a problem with registration: ' + error.message;
                throw error;
            }
        }
    };

</script>

</html>