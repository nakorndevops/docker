<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registration Status</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/versions/2.22.3/sdk.js"></script>

    <style>
        :root {
            --success-color: #28a745; --error-color: #dc3545; --text-color: #333333;
            --text-muted: #6c757d; --bg-color: #f4f6f8; --card-bg: #ffffff;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color); display: flex; justify-content: center;
            align-items: center; min-height: 100vh; margin: 0; padding: 20px;
        }
        .card {
            background-color: var(--card-bg); padding: 2.5rem; border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); text-align: center; max-width: 500px; width: 100%;
            display: none; animation: fadeIn 0.5s ease-out;
        }
        .card.visible { display: block; }
        h1 { margin-top: 0; font-size: 1.75rem; margin-bottom: 1rem; }
        .text-success { color: var(--success-color); } .text-error { color: var(--error-color); }
        .error-message { color: var(--text-muted); font-size: 1.1rem; margin-bottom: 1.5rem; line-height: 1.5; }
        .info-grid {
            display: grid; grid-template-columns: auto 1fr; gap: 0.75rem 1.5rem;
            text-align: left; margin: 1.5rem auto; width: fit-content; font-size: 1rem;
        }
        .info-label { font-weight: 600; color: var(--text-color); }
        .info-value { color: var(--text-muted); text-align: right; }
        .btn {
            border: none; padding: 12px 24px; font-size: 1rem; border-radius: 6px;
            cursor: pointer; transition: opacity 0.2s ease; font-weight: 600; color: white;
            text-decoration: none; display: inline-block; margin-top: 1rem;
        }
        .btn:hover { opacity: 0.9; }
        .btn-success { background-color: var(--success-color); }
        .btn-error { background-color: var(--error-color); }
        .loading-container { display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .spinner {
            border: 4px solid #f3f3f3; border-top: 4px solid #007bff; border-radius: 50%;
            width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 1rem;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="loading-view" class="loading-container">
        <div class="spinner"></div>
        <p id="loading-text">Loading system...</p>
    </div>

    <div id="success-view" class="card">
        <h1 class="text-success">Registration Successful! ðŸŽ‰</h1>
        <div class="info-grid">
            <div class="info-label">Name</div><div id="display-name" class="info-value">-</div>
            <div class="info-label">Position</div><div id="display-position" class="info-value">-</div>
            <div class="info-label">License ID</div><div id="display-license" class="info-value">-</div>
            <div class="info-label">Hospital</div><div id="display-hospital" class="info-value">-</div>
        </div>
        <button class="btn btn-success" onclick="liff.closeWindow()">Close Window</button>
    </div>

    <div id="error-view" class="card">
        <h1 class="text-error">Registration Failed</h1>
        <p id="error-message-text" class="error-message">Unknown error occurred.</p>
        <a href="/providerid-login" class="btn btn-error">Try Again</a>
    </div>

    <script>
        const CONFIG = {
            LOGIN_PAGE_URL: "https://dh.tranghos.moph.go.th/providerid-login?origin=register",
            API_ENDPOINTS: {
                CONFIG: "https://dh.tranghos.moph.go.th/register-backend/config",
                LINK_ACCOUNT: "https://dh.tranghos.moph.go.th/register-backend/linkAccount"
            }
        };

        const ui = {
            loadingView: document.getElementById('loading-view'),
            loadingText: document.getElementById('loading-text'),
            successView: document.getElementById('success-view'),
            errorView: document.getElementById('error-view'),
            fields: {
                name: document.getElementById('display-name'),
                position: document.getElementById('display-position'),
                license: document.getElementById('display-license'),
                hospital: document.getElementById('display-hospital'),
                errorMessage: document.getElementById('error-message-text')
            },
            updateLoading(text) { this.loadingText.textContent = text; },
            showSuccess(data) {
                this.loadingView.style.display = 'none';
                this.errorView.classList.remove('visible');
                const org = data.organization && data.organization[0] ? data.organization[0] : {};
                this.fields.name.textContent = data.name_th || "N/A";
                this.fields.position.textContent = org.position || "N/A";
                this.fields.license.textContent = org.license_id || "N/A";
                this.fields.hospital.textContent = org.hname_th || "N/A";
                this.successView.classList.add('visible');
            },
            showError(message) {
                this.loadingView.style.display = 'none';
                this.successView.classList.remove('visible');
                this.fields.errorMessage.textContent = message;
                this.errorView.classList.add('visible');
            }
        };

        async function fetchBackendConfig() {
            const res = await fetch(CONFIG.API_ENDPOINTS.CONFIG);
            if (!res.ok) throw new Error("Failed to load configuration");
            return await res.json();
        }

        async function linkUserAccount(payload) {
            try {
                const response = await fetch(CONFIG.API_ENDPOINTS.LINK_ACCOUNT, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                });
                const result = await response.json();
                return response.ok ? { success: true, data: result.data || result } : { success: false, error: result.error || `Status: ${response.status}` };
            } catch (error) {
                return { success: false, error: error.message };
            }
        }

        document.addEventListener('DOMContentLoaded', async function () {
            const urlParams = new URLSearchParams(window.location.search);
            const providerIdCode = urlParams.get('code');

            if (!providerIdCode) {
                window.location.replace(CONFIG.LOGIN_PAGE_URL);
                return;
            }

            try {
                // 1. Fetch Config
                ui.updateLoading("Loading configuration...");
                const backendConfig = await fetchBackendConfig();

                // 2. Init LIFF
                ui.updateLoading("Initializing LINE...");
                await liff.init({ liffId: backendConfig.registerLiffId });

                // 3. Check Login
                if (!liff.isLoggedIn()) {
                    liff.login({ redirectUri: window.location.href });
                    return;
                }

                // 4. Link Account
                ui.updateLoading("Processing registration...");
                const profile = await liff.getProfile();
                const currentUrl = window.location.href.split('?')[0];

                const result = await linkUserAccount({
                    LineUserId: profile.userId,
                    providerIdCode: providerIdCode,
                    redirect_uri: currentUrl
                });

                if (result.success) {
                    ui.showSuccess(result.data);
                } else {
                    ui.showError(result.error);
                }
            } catch (err) {
                console.error(err);
                ui.showError("Initialization failed: " + err.message);
            }
        });
    </script>
</body>
</html>