events {
    worker_connections 1024;
}

http {
    # --- Basic Optimization ---
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;
    server_tokens off; # Hide Nginx version

    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # --- Gzip Compression (Effectiveness) ---
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml application/json application/javascript application/rss+xml application/atom+xml image/svg+xml;

    # --- Rate Limiting (Security) ---
    # Define a zone: 10MB storage, limit by IP, 10 requests per second
    limit_req_zone $binary_remote_addr zone=one:10m rate=10r/s;

    resolver 127.0.0.11 valid=10s;

    # --- HTTP Redirect ---
    server {
        listen 80;
        server_name tranghos.moph.go.th;
        location / {
            return 301 https://$host$request_uri;
        }
    }    

    # --- HTTPS Server ---
    server {
        listen 443 ssl;
        http2 on; # Enable HTTP/2 for performance
        server_name tranghos.moph.go.th;

        # SSL Certificate
        ssl_certificate /etc/nginx/certs/proxy-server.crt;
        ssl_certificate_key /etc/nginx/certs/proxy-server.key;             

        # SSL Optimization
        ssl_session_timeout 1d;
        ssl_session_cache shared:SSL:50m;
        ssl_session_tickets off;

        # SSL Protocols & Ciphers
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384';
        ssl_prefer_server_ciphers off;

        # --- Security Headers ---
        add_header Strict-Transport-Security "max-age=63072000" always; # HSTS
        add_header X-Frame-Options "SAMEORIGIN" always; # Clickjacking protection
        add_header X-Content-Type-Options "nosniff" always; # MIME sniffing protection
        add_header X-XSS-Protection "1; mode=block" always; # XSS protection
        add_header Referrer-Policy "no-referrer-when-downgrade" always;

        # --- Proxy Defaults ---
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_ssl_verify off; # Internal self-signed certs

        # --- Locations with Rate Limiting ---
        
        location / {
            limit_req zone=one burst=20 nodelay; # Apply rate limit
            proxy_pass https://register-frontend:3000/providerid-login;
        }         

        location /providerid-login {
            limit_req zone=one burst=20 nodelay;
            proxy_pass https://register-frontend:3000/providerid-login;
        }                 

        location /register {
            limit_req zone=one burst=20 nodelay;
            proxy_pass https://register-frontend:3000/register;
        } 

        location /register-backend/ {
            limit_req zone=one burst=20 nodelay;
            proxy_pass https://register-backend:3002/;
        }            

        location /hosxp-api/ {
            proxy_pass https://hosxp-api:3001/;
        }

        location /user-db-api/ {
            proxy_pass https://user-db-api:3003/;
        }       

        location /icu-db-api/ {
            proxy_pass https://icu-db-api:3007/;
        } 

        location /or-db-api/ {
            proxy_pass https://or-db-api:3000/;
        }  

        location /or-monitor-backend/ {
            proxy_pass https://or-monitor-backend:3000/;
        }               

        location /line-webhook/ {
            # Webhooks might need higher limits or no limits
            proxy_pass https://line-webhook-server:3004/;
        }  

         location /logic/ {
            proxy_pass https://logic-server:3005/;
        }  

        location /favicon.ico {
            expires 1d; # Cache static assets
            proxy_pass https://file-server:3006/image/favicon.ico;
        }

        location /image/ {
            expires 1d;
            proxy_pass https://file-server:3006/image/;
        }

        location /icu/ {
            proxy_pass https://icu-frontend:3008/;
        }

        location /icu-backend/ {
            proxy_pass https://icu-backend:3009/;
        }

        location /authen-server/ {
            proxy_pass https://authen-server:3000/;
        }                                                        
    }
}